/*! Copyright College of Direct Support */
var Matching=(function(f){var g=[];var k,i,e,h,d;var j=f('<div id="ansarea_select_hint" class="visually_hidden"></div>');var c={mode:"default",shuffle_statements:false,statements_pos_left:0,answers_pos_left:0,fore_opacity:1,statements_back_opacity:0.15,answers_back_opacity:0.5,transition_length:500,statement_selected_flag:false,ansarea_selected_flag:true,msg_default:"",msg_ss_part1:"You've selected <span class='msg_action_accomplished'>",msg_ss_part2:"</span> now click its match.",msg_statement_selected:function(){return a.buildMessageFrom(c.msg_ss_part1,l.statement_text,c.msg_ss_part2)},msg_correct:"Correct!",msg_fail:"Not a match! Give it another try.",msg_win:"Congratulations, you've successfully matched all the items!",msg_win_any_answer_is_fine:"Take a minute to reflect on your answers.",long_statements:false,any_answer_is_fine:false};var b={container_height:0,padmeh:0,aa_rest_width:0,offset:0,offset_left:0,aa_rest_x:0};var l={statement_id:0,matching_area_ids:"",blanknum:null,feedback:null,statement_text:"","$statement_html":null};var a={init:function(o){k=o.addClass("matching_ui");i=k.find("#statement_defs");e=k.find("#answer_areas");h=f("#message",k);d=f('<div id="feedback_dialogue"><div class="feedback_body"></div><div class="feedback_control"><a href="">Close feedback</a></div></div>');b.container_height=k.height();d.height(b.container_height);f(".feedback_control",d).on("click.Matching","a",function(z){z.preventDefault();d.hide();l.feedback=null});k.append(d);h.addClass("msg_default");c.statements_pos_left=i.position().left;c.answers_pos_left=e.position().left;i.find("h2").wrapInner('<a id="answers_group" tabindex="0">');i.addClass("foreground");e.addClass("background");var p=k.find("#statement_defs dd").clone();var u=f(),y=[],x=[],q=[],n,s,m,t,w;var r=k.find("#statement_defs dl").detach();var v=r.children();v.each(function(z){$this=f(this);if($this.is("dt")){u=u.add($this);if(x.length>0){y.push(x);x=[]}}if($this.is("dd")){x.push($this.attr("class"));if(z+1==v.length){y.push(x)}n=f(".feedback",$this);if(n.length>0){s=f(".feedback_correct",n);m=f(".feedback_incorrect",n);if(s.length==1){t=s.text()}if(m.length==1){w=m.text()}q.push({fb_correct:t,fb_incorrect:w})}}});this.buildStatements(u,y,q);this.buildAnsAreas(p);b.aa_rest_width=e.width();b.aa_rest_x=e.position().left;b.padmeh=Math.floor((k.width()-b.aa_rest_width)/2);b.offset=k.width()-(b.aa_rest_width+e.position().left);b.offset_left=b.padmeh-b.offset;b.wee_padmeh=Math.ceil(b.padmeh*0.4);b.add_width=Math.floor(b.padmeh*0.6)*2},buildStatements:function(q,p,o){var s=jQuery();var r,n;q.each(function(t){if(c.mode=="fill-in-the-blank"){if(f(this).find("span[data-blanknum]").length>0){f(this).addClass("skipme");f(this).find("span[data-blanknum]").each(function(u){r=f('<a href="">'+f(this).html()+"</a>").data("controlData",{id:t+"."+u,matching_answer_ids:p[t],blanknum:f(this).attr("data-blanknum"),feedback:""});if(f(this).is("*[data-feedback]")){r.data("controlData").feedback=jQuery.parseJSON(f(this).attr("data-feedback"))}s=s.add((f("<li></li>").append(r)))})}}if(!f(this).hasClass("skipme")){r=f('<a href="">'+f(this).html()+"</a>").data("controlData",{id:t,matching_answer_ids:p[t],feedback:o[t]});if(f(this).is("*[data-feedback]")){r.data("controlData").feedback=jQuery.parseJSON(f(this).attr("data-feedback"))}s=s.add((f("<li></li>").append(r)))}});if(c.shuffle_statements){var m=a.shuffle(s.toArray());i.append(f("<ul></ul>").append(jQuery(m)))}else{if(!c.shuffle_statements){i.append(f("<ul></ul>").append(s))}}this.statementsBind()},statementClick:function(n){n.preventDefault();if(c.statement_selected_flag){return}else{c.statement_selected_flag=true;var m=f(this);l.statement_id=m.data("controlData").id;l.matching_area_ids=m.data("controlData").matching_answer_ids;l.feedback=m.data("controlData").feedback;l.statement_text=m.text();l.$statement_html=m.html();if(c.mode=="fill-in-the-blank"){if(m.data("controlData").blanknum){l.blanknum=m.data("controlData").blanknum}}e.find("li").each(function(){f(this).find(".screenreader_hint").text("Does "+l.statement_text+" match this answer?")});a.displaySelectedStatementHints(f(this).text());a.swapZindexes();a.transitionStatementsToBack();a.transitionAnsareasToFore();f("#answers_group",e).focus();c.ansarea_selected_flag=false}},displaySelectedStatementHints:function(m){j.html('<p><span class="hint_label">Currently selected: </span><span class="hint_text">'+m+"</span></p>")},statementsBind:function(){i.on("click.Matching","a",a.statementClick)},buildAnsAreas:function(q){q.each(function(){g.push(f(this).attr("class"))});var p=a.uniquesFromArray(g);var o=jQuery();for(var n=0,m=p.length;n<m;n++){o=o.add('<li id="'+p[n]+'" class="answer_area"><a href=""><span class="area_title">'+q.filter("."+p[n]).first().html()+'</span><span class="visually_hidden screenreader_hint"></span> <span class="aa_store"></span></a></li>')}e.append(f("<ul></ul>").append(o));e.prepend(j);e.find("h2").wrapInner('<a id="answers_group" tabindex="0"></a>');this.ansAreasBind()},ansAreasBind:function(){e.on("click.Matching","a",a.ansAreaClick)},ansAreaClick:function(r){r.preventDefault();if(c.ansarea_selected_flag){return}else{c.ansarea_selected_flag=true;var q=f(this).parent().attr("id");var p=false;for(var o=0,m=l.matching_area_ids.length;o<m;o++){if(l.matching_area_ids[o]==q){p=true}}if(p){if(c.mode=="default"){f(this).find(".aa_store").append(f('<span class="dropped_statement"></span>').append(l.$statement_html))}else{if(c.mode=="fill-in-the-blank"){var n;if(l.blanknum){n=f(this).find("."+l.blanknum)}else{n=f(this).find(".fitb-blank")}n.replaceWith(f('<span class="dropped_statement"></span>').append(l.$statement_html))}}a.dropSuccess();if(!a.checkExerciseComplete()){if(!c.any_answer_is_fine){a.message("correct")}else{a.message()}}else{if(c.any_answer_is_fine){c.msg_win=c.msg_win_any_answer_is_fine}a.message("win")}}else{a.message("fail")}l.blanknum=null;e.find("li").each(function(){f(this).find(".screenreader_hint").text("")})}},swapZindexes:function(){i.toggleClass("foreground background");e.toggleClass("foreground background")},transitionStatementsToBack:function(){i.animate({left:"+=50",top:"+=50",opacity:c.statements_back_opacity,"font-size":".9em"},c.transition_length,function(){a.message("msg_statement_selected")})},transitionStatementsToFore:function(){i.animate({left:"-=50",top:"-=50",opacity:c.fore_opacity,"font-size":"1em"},c.transition_length,function(){if(c.any_answer_is_fine){a.message("default")}})},transitionAnsareasToFore:function(){if(c.long_statements===true){f(".dropped_statement",e).animate({"font-size":"1em"},c.transition_length);e.animate({width:"+="+b.add_width,left:b.wee_padmeh,opacity:c.fore_opacity},c.transition_length,function(){e.css({"padding-left":b.wee_padmeh,"padding-right":b.wee_padmeh,left:0})})}else{e.animate({left:b.padmeh,opacity:c.fore_opacity},c.transition_length,function(){e.css({"padding-left":b.padmeh,"padding-right":b.padmeh,left:0})})}},transitionAnsareasToBack:function(){var m,n;if(!c.long_statements){m={left:b.aa_rest_x,opacity:c.answers_back_opacity};n=b.padmeh}else{if(c.long_statements){m={width:b.aa_rest_width,left:b.aa_rest_x,opacity:c.answers_back_opacity};n=b.wee_padmeh;f(".dropped_statement",e).animate({"font-size":".7em"},c.transition_length)}}e.css({"padding-left":0,"padding-right":0,left:n});j.empty();e.animate(m,c.transition_length)},transitionForTheWin:function(){j.empty();i.hide(1000)},message:function(n){var m="";h.slideUp(200,function(){if(n=="msg_statement_selected"){if(h.hasClass("msg_correct")){h.removeClass("msg_correct")}if(h.hasClass("msg_fail")){h.removeClass("msg_fail")}h.addClass("msg_steps");m=c.msg_statement_selected}else{if(n=="correct"){h.removeClass("msg_steps").addClass("msg_correct");m=c.msg_correct;if(l.feedback){if(l.feedback.correct){d.find(".feedback_body").text(l.feedback.correct);d.show()}}}else{if(n=="fail"){h.removeClass("msg_steps").addClass("msg_fail");m=c.msg_fail;if(l.feedback){if(l.feedback.incorrect){d.find(".feedback_body").text(l.feedback.incorrect);d.show()}}}else{if(n=="win"){h.removeClass("msg_correct, msg_steps").addClass("msg_win");m=c.msg_win;if(l.feedback){if(l.feedback.correct){d.find(".feedback_body").text(l.feedback.correct);d.show()}}}else{if(n=="default"){h.removeClass("msg_steps").addClass("msg_default");m=c.msg_default}else{if(n==""||n==null){h.removeClass("msg_steps").addClass("msg_default");a.transitionStatementsToFore();a.transitionAnsareasToBack();a.swapZindexes();c.statement_selected_flag=false;return}}}}}}f("h1",h).html(m);h.slideDown(500,function(){h.focus();if(n=="correct"||n=="fail"){a.transitionStatementsToFore();a.transitionAnsareasToBack();a.swapZindexes();c.statement_selected_flag=false}else{if(n=="win"){e.addClass("win");a.transitionForTheWin()}}})})},buildMessageFrom:function(){var m="";for(var n=0;n<arguments.length;n++){m+=arguments[n]}return m},dropSuccess:function(){i.find("li a").each(function(){var m=f(this);if(m.data("controlData").id==l.statement_id){m.unbind("click.Matching",a.statementClick);m.remove();return}})},checkExerciseComplete:function(){if(!i.find("li a").length){return true}else{return false}},uniquesFromArray:function(o){var p=[],n=o.length,q,m,r;for(m=0;m<n;m++){q=undefined;for(r=0;r<p.length;r++){if(o[m]===p[r]){q=true;break}}if(!q){p.push(o[m])}}return p},shuffle:function(p){var m,o,n=p.length;if(n){while(--n){o=Math.floor(Math.random()*(n+1));m=p[o];p[o]=p[n];p[n]=m}}return p}};return{setMessage:function(n,m){if(n=="correct"){c.msg_correct=m}else{if(n=="fail"){c.msg_fail=m}else{if(n=="win"){c.msg_win=m}else{if(n=="default"){c.msg_default=m}}}}},init:function(m,n){if(n){f.extend(c,n)}a.init(m)}}})(jQuery);