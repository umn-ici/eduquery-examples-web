/*! Copyright College of Direct Support */
var Matching=function(a,b){this.ddClassNames=[];this.$container;this.$statements_container;this.$ansareas_container;this.$instructions;this.$feedback_dialogue;this.$rawAnswers;this.$rawStatements=$();this.answerGroups=[];this.group=[];this.feedbackArray=[];this.$fb;this.$feedback_correct;this.$feedback_incorrect;this.fb_correct;this.fb_incorrect;this.$dataInMarkup;this.$children;this.$ansarea_select_hint=$('<div class="ansarea_select_hint visually_hidden" tabindex="0"></div>');this.settings={mode:"default",shuffle_statements:false,statements_pos_left:0,answers_pos_left:0,fore_opacity:1,statements_back_opacity:0.15,answers_back_opacity:0.5,transition_length:500,statement_selected_flag:false,ansarea_selected_flag:true,msg_default:"",msg_ss_part1:"You've selected <span class='msg_action_accomplished'>",msg_ss_part2:"</span> now click its match.",msg_statement_selected:$.proxy(function(){return this.buildMessageFrom(this.settings.msg_ss_part1,this.bin.statement_text,this.settings.msg_ss_part2)},this),msg_correct:"Correct!",msg_fail:"Not a match! Give it another try.",msg_win:"Congratulations, you've successfully matched all the items!",msg_win_any_answer_is_fine:"Take a minute to reflect on your answers.",long_statements:false,any_answer_is_fine:false};this.animata={container_height:0,padmeh:0,aa_rest_width:0,offset:0,offset_left:0,aa_rest_x:0};this.bin={statement_id:0,matching_area_ids:"",blanknum:null,feedback:null,fb_class:"",statement_text:"","$statement_html":null,show_fb_win_flag:true};this.init(a,b)};Matching.prototype.init=function(a,b){if(b){$.extend(this.settings,b)}this.$container=a.addClass("matching_ui");this.$statements_container=this.$container.find(".statement_defs");this.$ansareas_container=this.$container.find(".answer_areas");this.$instructions=$(".instructions",this.$container);this.$feedback_dialogue=$('<div class="feedback_dialogue"><div class="feedback_body" tabindex="0"></div><div class="feedback_control"><a href="">Close feedback</a></div></div>');this.animata.container_height=this.$container.height();this.$feedback_dialogue.height(this.animata.container_height);if(this.settings.msg_default==""){this.settings.msg_default=$("h1",this.$instructions).text()}$(".feedback_control",this.$feedback_dialogue).on("click.Matching","a",$.proxy(function(c){c.preventDefault();this.$instructions.focus();this.$feedback_dialogue.hide();this.bin.feedback=null;this.$feedback_dialogue.find(".feedback_body").removeClass(this.bin.fb_class);this.bin.fb_class="";if(this.bin.show_fb_win_flag&&this.checkExerciseComplete()){this.bin.show_fb_win_flag=false;if(this.settings.any_answer_is_fine){this.settings.msg_win=this.settings.msg_win_any_answer_is_fine}this.message("win")}},this));this.$container.append(this.$feedback_dialogue);this.$instructions.addClass("msg_default");this.settings.statements_pos_left=this.$statements_container.position().left;this.settings.answers_pos_left=this.$ansareas_container.position().left;this.$statements_container.find("h2").wrapInner('<a class="statements_group" tabindex="0">');this.$statements_container.addClass("foreground");this.$ansareas_container.addClass("background");this.$rawAnswers=this.$container.find(".statement_defs dd").clone();this.$dataInMarkup=this.$container.find(".statement_defs dl").detach();this.$children=this.$dataInMarkup.children();this.$children.each($.proxy(function(c,d){$this=$(d);if($this.is("dt")){this.$rawStatements=this.$rawStatements.add($this);if(this.group.length>0){this.answerGroups.push(this.group);this.group=[]}}if($this.is("dd")){this.group.push($this.attr("class"));if(c+1==this.$children.length){this.answerGroups.push(this.group)}this.$fb=$(".feedback",$this);if(this.$fb.length>0){this.$feedback_correct=$(".feedback_correct",this.$fb);this.$feedback_incorrect=$(".feedback_incorrect",this.$fb);if(this.$feedback_correct.length==1){this.fb_correct=this.$feedback_correct.text()}if(this.$feedback_incorrect.length==1){this.fb_incorrect=this.$feedback_incorrect.text()}this.feedbackArray.push({fb_correct:this.fb_correct,fb_incorrect:this.fb_incorrect})}}},this));this.buildStatements(this.$rawStatements,this.answerGroups,this.feedbackArray);this.buildAnsAreas(this.$rawAnswers);this.animata.aa_rest_width=this.$ansareas_container.width();this.animata.aa_rest_x=this.$ansareas_container.position().left;this.animata.padmeh=Math.floor((this.$container.width()-this.animata.aa_rest_width)/2);this.animata.offset=this.$container.width()-(this.animata.aa_rest_width+this.$ansareas_container.position().left);this.animata.offset_left=this.animata.padmeh-this.animata.offset;this.animata.wee_padmeh=Math.ceil(this.animata.padmeh*0.4);this.animata.add_width=Math.floor(this.animata.padmeh*0.6)*2;this.$rawAnswers=null;this.$dataInMarkup=null;this.$children=null;this.$fb=null;this.$feedback_correct=null;this.$feedback_incorrect=null;this.fb_correct=null;this.fb_incorrect=null};Matching.prototype.buildStatements=function(e,d,c){var g=jQuery();var f,b;e.each($.proxy(function(h,i){if(this.settings.mode=="fill-in-the-blank"){if($(i).find("span[data-blanknum]").length>0){$(i).addClass("skipme");$(i).find("span[data-blanknum]").each($.proxy(function(k,j){f=$('<a href="">'+$(j).html()+"</a>").data("controlData",{id:h+"."+k,matching_answer_ids:d[h],blanknum:$(j).attr("data-blanknum"),feedback:""});if($(j).is("*[data-feedback]")){f.data("controlData").feedback=jQuery.parseJSON($(j).attr("data-feedback"))}g=g.add(($("<li></li>").append(f)))},this))}}if(!$(i).hasClass("skipme")){f=$('<a href="">'+$(i).html()+"</a>").data("controlData",{id:h,matching_answer_ids:d[h],feedback:c[h]});if($(i).is("*[data-feedback]")){f.data("controlData").feedback=jQuery.parseJSON($(i).attr("data-feedback"))}g=g.add(($("<li></li>").append(f)))}},this));if(this.settings.shuffle_statements){var a=this.shuffle(g.toArray());this.$statements_container.append($("<ul></ul>").append(jQuery(a)))}else{if(!this.settings.shuffle_statements){this.$statements_container.append($("<ul></ul>").append(g))}}this.statementsBind();e=null;d=null;c=null;g=null;f=null;b=null};Matching.prototype.statementClick=function(b){b.preventDefault();if(this.settings.statement_selected_flag){return}else{this.settings.statement_selected_flag=true;var a=$(b.target);this.bin.statement_id=a.data("controlData").id;this.bin.matching_area_ids=a.data("controlData").matching_answer_ids;this.bin.feedback=a.data("controlData").feedback;this.bin.statement_text=a.text();this.bin.$statement_html=a.html();if(this.settings.mode=="fill-in-the-blank"){if(a.data("controlData").blanknum){this.bin.blanknum=a.data("controlData").blanknum}}this.$ansareas_container.find("li").each($.proxy(function(c,d){$(d).find(".screenreader_hint").text("Does "+this.bin.statement_text+" match this answer?")},this));this.displaySelectedStatementHints(a.text());this.swapZindexes();this.transitionStatementsToBack();this.transitionAnsareasToFore();this.$ansarea_select_hint.focus();this.settings.ansarea_selected_flag=false}};Matching.prototype.displaySelectedStatementHints=function(a){this.$ansarea_select_hint.html('<p tabindex="0">You selected <em class="hint_text">'+a+"</em>, now find its match below:</p>")};Matching.prototype.statementsBind=function(){this.$statements_container.on("click.Matching","a",$.proxy(this.statementClick,this))};Matching.prototype.buildAnsAreas=function(e){e.each($.proxy(function(f,g){this.ddClassNames.push($(g).attr("class"))},this));var d=this.uniquesFromArray(this.ddClassNames);var c=jQuery();for(var b=0,a=d.length;b<a;b++){c=c.add('<li id="'+d[b]+'" class="answer_area"><a href=""><span class="area_title">'+e.filter("."+d[b]).first().html()+'</span><span class="visually_hidden screenreader_hint"></span> <span class="aa_store"></span></a></li>')}this.$ansareas_container.append($("<ul></ul>").append(c));this.$ansareas_container.prepend(this.$ansarea_select_hint);this.$ansareas_container.find("h2").wrapInner('<a class="answers_group"></a>');this.ansAreasBind()};Matching.prototype.ansAreasBind=function(){this.$ansareas_container.on("click.Matching","a",$.proxy(this.ansAreaClick,this))};Matching.prototype.ansAreaClick=function(h){h.preventDefault();if(this.settings.ansarea_selected_flag){return}else{this.settings.ansarea_selected_flag=true;var g=$(h.target);if(g.is("span")){g=g.closest("a")}var f=g.parent().attr("id");var d=false;for(var c=0,a=this.bin.matching_area_ids.length;c<a;c++){if(this.bin.matching_area_ids[c]==f){d=true}}if(d){if(this.settings.mode=="default"){g.find(".aa_store").append($('<span class="dropped_statement"></span>').append(this.bin.$statement_html))}else{if(this.settings.mode=="fill-in-the-blank"){var b;if(this.bin.blanknum){b=g.find("."+this.bin.blanknum)}else{b=g.find(".fitb-blank")}b.replaceWith($('<span class="dropped_statement"></span>').append(this.bin.$statement_html))}}this.dropSuccess();if(!this.settings.any_answer_is_fine){this.message("correct")}else{this.message()}}else{this.message("fail")}this.bin.blanknum=null;this.$ansareas_container.find("li").each($.proxy(function(e,i){$(i).find(".screenreader_hint").text("")},this))}};Matching.prototype.message=function(c){var a="",b="";if(c=="default"){this.$instructions.removeClass("msg_steps").addClass("msg_default");a=this.settings.msg_default;$("h1",this.$instructions).html(a);return}else{if(c=="msg_statement_selected"){this.$instructions.slideUp(100,$.proxy(function(){this.$instructions.addClass("msg_steps");a=this.settings.msg_statement_selected;$("h1",this.$instructions).html(a);this.$instructions.slideDown(100,$.proxy(function(){},this))},this))}else{if(c=="correct"){if(this.bin.feedback&&this.bin.feedback.correct){b=this.bin.feedback.correct}else{b=this.settings.msg_correct}this.$feedback_dialogue.find(".feedback_body").text(b).addClass("fb_correct");this.bin.fb_class="fb_correct";this.$feedback_dialogue.show();this.$feedback_dialogue.find(".feedback_body").focus()}else{if(c=="fail"){if(this.bin.feedback&&this.bin.feedback.incorrect){b=this.bin.feedback.incorrect}else{b=this.settings.msg_fail}this.$feedback_dialogue.find(".feedback_body").text(b).addClass("fb_fail");this.bin.fb_class="fb_fail";this.$feedback_dialogue.show();this.$feedback_dialogue.find(".feedback_body").focus()}else{if(c=="win"){b=this.settings.msg_win;this.$feedback_dialogue.find(".feedback_body").text(b).addClass("fb_win");this.bin.fb_class="fb_win";this.$feedback_dialogue.show();this.$feedback_dialogue.find(".feedback_body").focus()}else{if(c==""||c==null){this.$instructions.removeClass("msg_steps").addClass("msg_default");this.transitionStatementsToFore();this.transitionAnsareasToBack();this.swapZindexes();this.settings.statement_selected_flag=false;return}}}}}}if(c=="correct"||c=="fail"){this.transitionStatementsToFore();this.transitionAnsareasToBack();this.swapZindexes();this.settings.statement_selected_flag=false;this.message("default")}else{if(c=="win"){this.$ansareas_container.addClass("win");this.transitionForTheWin();$("h1",this.$instructions).html("")}}};Matching.prototype.swapZindexes=function(){this.$statements_container.toggleClass("foreground background");this.$ansareas_container.toggleClass("foreground background")};Matching.prototype.transitionStatementsToBack=function(){this.$statements_container.animate({left:"+=50",top:"+=50",opacity:this.settings.statements_back_opacity,"font-size":".9em"},this.settings.transition_length,$.proxy(function(){if(this.bin.show_fb_win_flag){this.message("msg_statement_selected")}},this))};Matching.prototype.transitionStatementsToFore=function(){this.$statements_container.animate({left:"-=50",top:"-=50",opacity:this.settings.fore_opacity,"font-size":"1em"},this.settings.transition_length,$.proxy(function(){if(this.settings.any_answer_is_fine){this.message("default")}},this))};Matching.prototype.transitionAnsareasToFore=function(){if(this.settings.long_statements===true){$(".dropped_statement",this.$ansareas_container).animate({"font-size":"1em"},this.settings.transition_length);this.$ansareas_container.animate({width:"+="+this.animata.add_width,left:this.animata.wee_padmeh,opacity:this.settings.fore_opacity},this.settings.transition_length,$.proxy(function(){this.$ansareas_container.css({"padding-left":this.animata.wee_padmeh,"padding-right":this.animata.wee_padmeh,left:0})},this))}else{this.$ansareas_container.animate({left:this.animata.padmeh,opacity:this.settings.fore_opacity},this.settings.transition_length,$.proxy(function(){this.$ansareas_container.css({"padding-left":this.animata.padmeh,"padding-right":this.animata.padmeh,left:0})},this))}};Matching.prototype.transitionAnsareasToBack=function(){var a=null,b=null;if(!this.settings.long_statements){a={left:this.animata.aa_rest_x,opacity:this.settings.answers_back_opacity};b=this.animata.padmeh}else{if(this.settings.long_statements){a={width:this.animata.aa_rest_width,left:this.animata.aa_rest_x,opacity:this.settings.answers_back_opacity};b=this.animata.wee_padmeh;$(".dropped_statement",this.$ansareas_container).animate({"font-size":".7em"},this.settings.transition_length)}}this.$ansareas_container.css({"padding-left":0,"padding-right":0,left:b});this.$ansarea_select_hint.empty();this.$ansareas_container.animate(a,this.settings.transition_length)};Matching.prototype.transitionForTheWin=function(){this.$ansarea_select_hint.empty();this.$statements_container.hide(1000);this.transitionStatementsToBack();this.transitionAnsareasToFore()};Matching.prototype.buildMessageFrom=function(){var a="";for(var b=0;b<arguments.length;b++){a+=arguments[b]}return a};Matching.prototype.dropSuccess=function(){this.$statements_container.find("li a").each($.proxy(function(a,b){var c=$(b);if(c.data("controlData").id==this.bin.statement_id){c.unbind("click.Matching",this.statementClick);c.remove();return}},this))};Matching.prototype.checkExerciseComplete=function(){if(!this.$statements_container.find("li a").length){return true}else{return false}};Matching.prototype.uniquesFromArray=function(c){var d=[],b=c.length,e,a,f;for(a=0;a<b;a++){e=undefined;for(f=0;f<d.length;f++){if(c[a]===d[f]){e=true;break}}if(!e){d.push(c[a])}}return d};Matching.prototype.shuffle=function(d){var a,c,b=d.length;if(b){while(--b){c=Math.floor(Math.random()*(b+1));a=d[c];d[c]=d[b];d[b]=a}}return d};Matching.prototype.setMessage=function(b,a){if(b=="correct"){this.settings.msg_correct=a}else{if(b=="fail"){this.settings.msg_fail=a}else{if(b=="win"){this.settings.msg_win=a}else{if(b=="default"){this.settings.msg_default=a}}}}};