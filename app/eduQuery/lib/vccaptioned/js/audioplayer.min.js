"use strict";var AudioPlayer=function(a){this.$context=a,this.mp3FileName=this.$context.attr("data-filename-mp3"),this.oggFileName=this.$context.attr("data-filename-ogg"),this.captionFileName=this.$context.attr("data-caption-track"),this.init()};AudioPlayer.prototype.init=function(){var a=!1,b=document.createElement("audio");if(b.canPlayType&&(b.canPlayType("audio/mp3").replace(/no/,"")||b.canPlayType("audio/ogg").replace(/no/,""))&&(a=!0),!a)return void 0!==this.captionFileName?(this.swfloc=this.$context.attr("id"),this.flashvars={mp3filepath:this.mp3FileName,captionsfilepath:this.captionFileName},swfobject.embedSWF("../lib/vccaptioned/playVoiceClipCaptioned.swf",this.swfloc,"400","60","10.0.0",!1,this.flashvars,{wmode:"transparent"},null)):this.$context.append("<p>Your Browser does not support html audio</p>"),!1;var c="Press to pause audio clip.",d="Press to play audio clip.";void 0!==this.captionFileName?(this.audioplayer='<div class="player"><audio>',""!==this.oggFileName&&(this.audioplayer+='<source src="'+this.oggFileName+'"  type="audio/ogg" >'),""!==this.mp3FileName&&(this.audioplayer+='<source src="'+this.mp3FileName+'"  type="audio/mp3" >'),this.audioplayer+='<track src="'+this.captionFileName+'" kind="caption" srclang="en-US" label="English" crossorigin="anonymous">                                </audio>                                <button class="playback-control notplaying">                                    <div><span class="button-text visually_hidden">'+d+'</span></div>                                </button>                                <div class="gutter">                                    <div class="handle" ></div>                                    <div class="captions">                                        <div aria-live="off" class="captionBar"></div>                                    </div>                               </div>                            </div>',this.$context.append(this.audioplayer),this.audioElem=this.$context.find("audio").get(0),this.positionIndicator=this.$context.find(".handle"),this.captionObj=new Captioning({capsource:this.captionFileName,$captionTextElem:this.$context.find(".captionBar"),$audioElem:$(this.audioElem)}),$(this.audioElem).on("timeupdate",$.proxy(function(){this.captionObj.timeupdate(this.audioElem.currentTime);var a=parseInt(this.audioElem.currentTime/this.audioElem.duration*100,10);this.positionIndicator.stop().animate({width:a+"%"},200,"linear")},this))):(this.audioplayerlittle='<div class="player mini-player"><audio>',""!==this.oggFileName&&(this.audioplayerlittle+='<source src="'+this.oggFileName+'"  type="audio/ogg" >'),""!==this.mp3FileName&&(this.audioplayerlittle+='<source src="'+this.mp3FileName+'"  type="audio/mp3" >'),this.audioplayerlittle+='</audio>                                            <button class="playback-control notplaying">                                                <div><span class="button-text visually_hidden">'+d+"</span></div>                                            </button>                                        </div>",this.$context.append(this.audioplayerlittle),this.audioElem=this.$context.find("audio").get(0)),$(this.audioElem).on("ended",$.proxy(function(){this.$context.find(".playback-control").removeClass("playing").addClass("notplaying"),this.audioElem.currentTime=0,this.audioElem.pause(),this.$context.find("button .button-text").text(d)},this)),this.$context.find(".playback-control").on("click",$.proxy(function(a){var b=$(a.target);b.is("button")||(b=b.closest("button"));var e=b.find(".button-text");this.audioElem.paused?(this.audioElem.play(),b.removeClass("notplaying").addClass("playing"),e.text(c)):(this.audioElem.pause(),b.removeClass("playing").addClass("notplaying"),e.text(d))},this))};var Captioning=function(a){this.parsedCaptions=[],this.textTrackCounter=0,this.currentCaptionData={},this.sourceFile=a.capsource,this.$captionTextElem=a.$captionTextElem,this.$audioElem=a.$audioElem,$.ajax({method:"get",url:this.sourceFile,dataType:"text",success:$.proxy(function(a){this.parsedCaptions=this.parseCaptionFile(a,this.getExtension(this.sourceFile))},this)}),this.$captionTextElem.hide().text("Use the play button to play the voice clip.").fadeIn(600),this.$audioElem.on("ended",$.proxy(function(){this.$captionTextElem.hide().text("Use the play button to replay the voice clip.").fadeIn(600),this.textTrackCounter=0,this.currentCaptionData={}},this))};Captioning.prototype.timeupdate=function(a){var b=parseFloat(a.toFixed(3)),c=!1;if(void 0!==this.currentCaptionData&&b<this.currentCaptionData.tcMax)return!1;var d=this.textTrackCounter,e=this.parsedCaptions.length;for(d;e>d;d++)if(b>this.parsedCaptions[d].tcMin&&b<this.parsedCaptions[d].tcMax){this.$captionTextElem.text(this.parsedCaptions[d].capText),this.textTrackCounter=d,this.currentCaptionData=this.parsedCaptions[d],c=!0;break}c||b>this.currentCaptionData.tcMax+5&&this.$captionTextElem.text("")},Captioning.prototype.parseCaptionFile=function(a,b){var c=[],d=[];"vtt"==b&&(a=a.replace(/WEBVTT+(\r\n\r\n|\n\n)/,""),a=a.replace(/(\r\n|\r|\n)/gm,"\n").split("\n\n")),"srt"==b&&(a=a.replace(/^[0-9]+$/gm,""),a=a.replace(/^\s+|\s+$/g,""),a=a.replace(/(\r\n|\r|\n)/gm,"\n").split("\n\n\n"));for(var e in a)d=a[e].split("\n"),c[e]={},c[e].capText=d[1],c[e].tcMin=parseFloat(this.timecode_min(d[0])),c[e].tcMax=parseFloat(this.timecode_max(d[0]));return c},Captioning.prototype.getExtension=function(a){var b=a;return b.split(".").pop().toLowerCase()},Captioning.prototype.timecode_min=function(a){var b;return a=a.replace(/,/g,"."),b=a.split(" --> "),this.tcsecs(b[0])},Captioning.prototype.timecode_max=function(a){var b;return a=a.replace(/,/g,"."),b=a.split(" --> "),this.tcsecs(b[1])},Captioning.prototype.tcsecs=function(a){var b,c,d;return c=a.split("."),d=c[0].split(":"),b=Math.floor(60*d[0]*60)+Math.floor(60*d[1])+Math.floor(d[2])+"."+c[1]},$(function(){$(".audioplayer").each(function(a){var b="ap"+a,c=a+1;new AudioPlayer($(this).attr({id:b,role:"region","aria-label":"Voiceclip "+c+"."}))})});