/*! Copyright College of Direct Support */
var Matching=(function(e){var f=[];var j,h,d,g;var i=e('<div id="ansarea_select_hint" class="hidden"></div>');var c={mode:"default",shuffle_statements:false,statements_pos_left:0,answers_pos_left:0,fore_opacity:1,statements_back_opacity:0.15,answers_back_opacity:0.5,transition_length:500,statement_selected_flag:false,ansarea_selected_flag:true,msg_default:"",msg_ss_part1:"You've selected <span class='msg_action_accomplished'>",msg_ss_part2:"</span> now click its match.",msg_statement_selected:function(){return a.buildMessageFrom(c.msg_ss_part1,k.statement_text,c.msg_ss_part2)},msg_correct:"Correct!",msg_fail:"Not a match! Give it another try.",msg_win:"Congratulations, you've successfully matched all the items!",long_statements:false,any_answer_is_fine:false};var b={padmeh:0,aa_rest_width:0,offset:0,offset_left:0,aa_rest_x:0};var k={statement_id:0,matching_area_ids:"",statement_text:"","$statement_html":null};var a={init:function(n){j=n.addClass("matching_ui");h=j.find("#statement_defs");d=j.find("#answer_areas");g=e("#message",j);g.addClass("msg_default");c.statements_pos_left=h.position().left;c.answers_pos_left=d.position().left;h.find("h2").wrapInner('<a id="answers_group" tabindex="0">');h.addClass("foreground");d.addClass("background");var r=j.find("#statement_defs dd").clone();var p=e(),o=[],q=[];var m=j.find("#statement_defs dl").detach();var l=m.children();l.each(function(s){$this=e(this);if($this.is("dt")){p=p.add($this);if(q.length>0){o.push(q);q=[]}}if($this.is("dd")){q.push($this.attr("class"));if(s+1==l.length){o.push(q)}}});this.buildStatements(p,o);this.buildAnsAreas(r);b.aa_rest_width=d.width();b.aa_rest_x=d.position().left;b.padmeh=Math.floor((j.width()-b.aa_rest_width)/2);b.offset=j.width()-(b.aa_rest_width+d.position().left);b.offset_left=b.padmeh-b.offset;b.wee_padmeh=Math.ceil(b.padmeh*0.4);b.add_width=Math.floor(b.padmeh*0.6)*2},buildStatements:function(o,n){var q=jQuery();var p,m;o.each(function(r){p=e('<a href="">'+e(this).html()+"</a>").data("controlData",{id:r,matching_answer_ids:n[r]});q=q.add((e("<li></li>").append(p)))});if(c.shuffle_statements){var l=a.shuffle(q.toArray());h.append(e("<ul></ul>").append(jQuery(l)))}else{if(!c.shuffle_statements){h.append(e("<ul></ul>").append(q))}}this.statementsBind()},statementClick:function(m){m.preventDefault();if(c.statement_selected_flag){return}else{c.statement_selected_flag=true;var l=e(this);k.statement_id=l.data("controlData").id;k.matching_area_ids=l.data("controlData").matching_answer_ids;k.statement_text=l.text();k.$statement_html=l.html();a.displaySelectedStatementHints(e(this).text());a.swapZindexes();a.transitionStatementsToBack();a.transitionAnsareasToFore();e("#answers_group",d).focus();c.ansarea_selected_flag=false}},displaySelectedStatementHints:function(l){i.html('<p><span class="hint_label">Currently selected: </span><span class="hint_text">'+l+"</span></p>")},statementsBind:function(){h.on("click.Matching","a",a.statementClick)},buildAnsAreas:function(p){p.each(function(){f.push(e(this).attr("class"))});var o=a.uniquesFromArray(f);var n=jQuery();for(var m=0,l=o.length;m<l;m++){n=n.add('<li id="'+o[m]+'" class="answer_area"><a href=""><span class="area_title">'+p.filter("."+o[m]).first().html()+'</span> <span class="aa_store"></span></a></li>')}d.append(e("<ul></ul>").append(n));d.prepend(i);d.find("h2").wrapInner('<a id="answers_group" tabindex="0"></a>');this.ansAreasBind()},ansAreasBind:function(){d.on("click.Matching","a",a.ansAreaClick)},ansAreaClick:function(p){p.preventDefault();if(c.ansarea_selected_flag){return}else{c.ansarea_selected_flag=true;var o=e(this).parent().attr("id");var n=false;for(var m=0,l=k.matching_area_ids.length;m<l;m++){if(k.matching_area_ids[m]==o){n=true}}if(n){if(c.mode=="default"){e(this).find(".aa_store").append(e('<span class="dropped_statement"></span>').append(k.$statement_html))}else{if(c.mode=="fill-in-the-blank"){e(this).find(".fitb-blank").replaceWith(e('<span class="dropped_statement"></span>').append(k.$statement_html))}}a.dropSuccess();if(!a.checkExerciseComplete()){if(!c.any_answer_is_fine){a.message("correct")}else{a.message()}}else{if(c.any_answer_is_fine){c.msg_win="Take a minute to reflect on your answers."}a.message("win")}}else{a.message("fail")}}},swapZindexes:function(){h.toggleClass("foreground background");d.toggleClass("foreground background")},transitionStatementsToBack:function(){h.animate({left:"+=50",top:"+=50",opacity:c.statements_back_opacity,"font-size":".9em"},c.transition_length,function(){a.message("msg_statement_selected")})},transitionStatementsToFore:function(){h.animate({left:"-=50",top:"-=50",opacity:c.fore_opacity,"font-size":"1em"},c.transition_length,function(){if(c.any_answer_is_fine){a.message("default")}})},transitionAnsareasToFore:function(){if(c.long_statements===true){e(".dropped_statement",d).animate({"font-size":"1em"},c.transition_length);d.animate({width:"+="+b.add_width,left:b.wee_padmeh,opacity:c.fore_opacity},c.transition_length,function(){d.css({"padding-left":b.wee_padmeh,"padding-right":b.wee_padmeh,left:0})})}else{d.animate({left:b.padmeh,opacity:c.fore_opacity},c.transition_length,function(){d.css({"padding-left":b.padmeh,"padding-right":b.padmeh,left:0})})}},transitionAnsareasToBack:function(){var l,m;if(!c.long_statements){l={left:b.aa_rest_x,opacity:c.answers_back_opacity};m=b.padmeh}else{if(c.long_statements){l={width:b.aa_rest_width,left:b.aa_rest_x,opacity:c.answers_back_opacity};m=b.wee_padmeh;e(".dropped_statement",d).animate({"font-size":".7em"},c.transition_length)}}d.css({"padding-left":0,"padding-right":0,left:m});i.empty();d.animate(l,c.transition_length)},transitionForTheWin:function(){i.empty();h.hide(1000)},message:function(m){var l="";g.slideUp(200,function(){if(m=="msg_statement_selected"){if(g.hasClass("msg_correct")){g.removeClass("msg_correct")}if(g.hasClass("msg_fail")){g.removeClass("msg_fail")}g.addClass("msg_steps");l=c.msg_statement_selected}else{if(m=="correct"){g.removeClass("msg_steps").addClass("msg_correct");l=c.msg_correct}else{if(m=="fail"){g.removeClass("msg_steps").addClass("msg_fail");l=c.msg_fail}else{if(m=="win"){g.removeClass("msg_correct, msg_steps").addClass("msg_win");l=c.msg_win}else{if(m=="default"){g.removeClass("msg_steps").addClass("msg_default");l=c.msg_default}else{if(m==""||m==null){g.removeClass("msg_steps").addClass("msg_default");a.transitionStatementsToFore();a.transitionAnsareasToBack();a.swapZindexes();c.statement_selected_flag=false;return}}}}}}e("h1",g).html(l);g.slideDown(500,function(){g.focus();if(m=="correct"||m=="fail"){a.transitionStatementsToFore();a.transitionAnsareasToBack();a.swapZindexes();c.statement_selected_flag=false}else{if(m=="win"){d.addClass("win");a.transitionForTheWin()}}})})},buildMessageFrom:function(){var l="";for(var m=0;m<arguments.length;m++){l+=arguments[m]}return l},dropSuccess:function(){h.find("li a").each(function(){var l=e(this);if(l.data("controlData").id==k.statement_id){l.unbind("click.Matching",a.statementClick);l.remove();return}})},checkExerciseComplete:function(){if(!h.find("li a").length){return true}else{return false}},uniquesFromArray:function(n){var o=[],m=n.length,p,l,q;for(l=0;l<m;l++){p=undefined;for(q=0;q<o.length;q++){if(n[l]===o[q]){p=true;break}}if(!p){o.push(n[l])}}return o},shuffle:function(o){var l,n,m=o.length;if(m){while(--m){n=Math.floor(Math.random()*(m+1));l=o[n];o[n]=o[m];o[m]=l}}return o}};return{setMessage:function(m,l){if(m=="correct"){c.msg_correct=l}else{if(m=="fail"){c.msg_fail=l}else{if(m=="win"){c.msg_win=l}else{if(m=="default"){c.msg_default=l}}}}},init:function(l,m){if(m){e.extend(c,m)}a.init(l)}}})(jQuery);