/*! All rights reserved Research and Training Center on Community Living (RTC) at the University of Minnesota (rtcweb@umn.edu) */
/*! Author : Shawn Lawler */
var Matching=function(a,b){this.ddClassNames=[],this.$container,this.$statements_container,this.$ansareas_container,this.$instructions,this.$feedback_dialogue,this.$rawAnswers,this.$rawStatements=$(),this.answerGroups=[],this.group=[],this.feedbackArray=[],this.$fb,this.$feedback_correct,this.$feedback_incorrect,this.fb_correct,this.fb_incorrect,this.$dataInMarkup,this.$children,this.$ansarea_select_hint=$('<div class="ansarea_select_hint visually_hidden"></div>'),this.settings={mode:"default",shuffle_statements:!1,statements_pos_left:0,answers_pos_left:0,fore_opacity:1,statements_back_opacity:.15,answers_back_opacity:.5,transition_length:500,statement_selected_flag:!1,ansarea_selected_flag:!0,msg_default:"",msg_ss_part1:"You've selected <span class='msg_action_accomplished'>",msg_ss_part2:"</span> now click its match.",msg_statement_selected:$.proxy(function(){return this.buildMessageFrom(this.settings.msg_ss_part1,this.bin.statement_text,this.settings.msg_ss_part2)},this),msg_correct:"Correct!",msg_fail:"Not a match! Give it another try.",msg_win:"Congratulations, you've successfully matched all the items!",msg_win_any_answer_is_fine:"Take a minute to reflect on your answers.",long_statements:!1,any_answer_is_fine:!1},this.animata={container_height:0,padmeh:0,aa_rest_width:0,offset:0,offset_left:0,aa_rest_x:0},this.bin={statement_id:0,matching_area_ids:"",blanknum:null,feedback:null,fb_class:"",statement_text:"",$statement_html:null,show_fb_win_flag:!0},this.init(a,b)};Matching.prototype.init=function(a,b){b&&$.extend(this.settings,b),this.$container=a.addClass("matching_ui").attr({role:"region","aria-label":"Matching interactive exercise. Please use the highest (beginner) verbosity setting in your screen reading software."}),this.$statements_container=this.$container.find(".statement_defs"),this.$ansareas_container=this.$container.find(".answer_areas"),this.$instructions=$(".instructions",this.$container),this.$feedback_dialogue=$('<div class="feedback_dialogue" role="dialog" aria-label="Feedback on your answer." aria-describedby="feedback_content"><div class="feedback_body" id="feedback_content"></div><div class="feedback_control"><a href="" role="button">Close feedback</a></div></div>'),this.animata.container_height=this.$container.height(),this.$feedback_dialogue.height(this.animata.container_height),""==this.settings.msg_default&&(this.settings.msg_default=$("h1",this.$instructions).text()),$(".feedback_control",this.$feedback_dialogue).on("click.Matching, keydown.Matching","a",$.proxy(function(a){return"keydown"==a.type&&13!=a.which&&32!=a.which?!0:(a.preventDefault(),this.$statements_container.find("h2").focus(),this.$feedback_dialogue.hide(),this.bin.feedback=null,this.$feedback_dialogue.find(".feedback_body").removeClass(this.bin.fb_class),this.bin.fb_class="",void(this.bin.show_fb_win_flag&&this.checkExerciseComplete()&&(this.bin.show_fb_win_flag=!1,this.settings.any_answer_is_fine&&(this.settings.msg_win=this.settings.msg_win_any_answer_is_fine),this.message("win"))))},this)),this.$container.append(this.$feedback_dialogue),this.$instructions.addClass("msg_default"),this.settings.statements_pos_left=this.$statements_container.position().left,this.settings.answers_pos_left=this.$ansareas_container.position().left,this.$statements_container.addClass("foreground"),this.$ansareas_container.addClass("background"),this.$rawAnswers=this.$container.find(".statement_defs dd").clone(),this.$dataInMarkup=this.$container.find(".statement_defs dl").detach(),this.$children=this.$dataInMarkup.children(),this.$children.each($.proxy(function(a,b){$this=$(b),$this.is("dt")&&(this.$rawStatements=this.$rawStatements.add($this),this.group.length>0&&(this.answerGroups.push(this.group),this.group=[])),$this.is("dd")&&(this.group.push($this.attr("class")),a+1==this.$children.length&&this.answerGroups.push(this.group),this.$fb=$(".feedback",$this),this.$fb.length>0&&(this.$feedback_correct=$(".feedback_correct",this.$fb),this.$feedback_incorrect=$(".feedback_incorrect",this.$fb),1==this.$feedback_correct.length&&(this.fb_correct=this.$feedback_correct.text()),1==this.$feedback_incorrect.length&&(this.fb_incorrect=this.$feedback_incorrect.text()),this.feedbackArray.push({fb_correct:this.fb_correct,fb_incorrect:this.fb_incorrect})))},this)),this.buildStatements(this.$rawStatements,this.answerGroups,this.feedbackArray),this.bin.totalNumStatements=this.$statements_container.find("li a").length,this.$statements_container.find("h2").attr("tabindex","0").append('<span class="visually_hidden">'+this.statementContainerHint()+"</span>"),this.buildAnsAreas(this.$rawAnswers),this.animata.aa_rest_width=this.$ansareas_container.width(),this.animata.aa_rest_x=this.$ansareas_container.position().left,this.animata.padmeh=Math.floor((this.$container.width()-this.animata.aa_rest_width)/2),this.animata.offset=this.$container.width()-(this.animata.aa_rest_width+this.$ansareas_container.position().left),this.animata.offset_left=this.animata.padmeh-this.animata.offset,this.animata.wee_padmeh=Math.ceil(.4*this.animata.padmeh),this.animata.add_width=2*Math.floor(.6*this.animata.padmeh),this.$rawAnswers=null,this.$dataInMarkup=null,this.$children=null,this.$fb=null,this.$feedback_correct=null,this.$feedback_incorrect=null,this.fb_correct=null,this.fb_incorrect=null},Matching.prototype.statementContainerHint=function(){var a=this.$statements_container.find("li a").length,b=this.bin.totalNumStatements-a,c="- <em>Click any item listed below. ("+b+" of "+this.bin.totalNumStatements+" items matched)</em>";return c},Matching.prototype.buildStatements=function(a,b,c){var e,f,d=jQuery();if(a.each($.proxy(function(a,f){"fill-in-the-blank"==this.settings.mode&&$(f).find("span[data-blanknum]").length>0&&($(f).addClass("skipme"),$(f).find("span[data-blanknum]").each($.proxy(function(c,f){e=$('<a href="" role="button">'+$(f).html()+"</a>").data("controlData",{id:a+"."+c,matching_answer_ids:b[a],blanknum:$(f).attr("data-blanknum"),feedback:""}),$(f).is("*[data-feedback]")&&(e.data("controlData").feedback=jQuery.parseJSON($(f).attr("data-feedback"))),d=d.add($("<li></li>").append(e))},this))),$(f).hasClass("skipme")||(e=$('<a href="" role="button">'+$(f).html()+"</a>").data("controlData",{id:a,matching_answer_ids:b[a],feedback:c[a]}),$(f).is("*[data-feedback]")&&(e.data("controlData").feedback=jQuery.parseJSON($(f).attr("data-feedback"))),d=d.add($("<li></li>").append(e)))},this)),this.settings.shuffle_statements){var g=this.shuffle(d.toArray());this.$statements_container.append($("<ul></ul>").append(jQuery(g)))}else this.settings.shuffle_statements||this.$statements_container.append($("<ul></ul>").append(d));this.statementsBind(),this.$statements_container.attr("aria-disabled","false"),a=null,b=null,c=null,d=null,e=null,f=null},Matching.prototype.statementClick=function(a){if("keydown"==a.type&&13!=a.which&&32!=a.which)return!0;if(a.preventDefault(),!this.settings.statement_selected_flag){this.settings.statement_selected_flag=!0;var b;b=$(a.target).is("a")?$(a.target):$(a.target).closest("a"),this.bin.statement_id=b.data("controlData").id,this.bin.matching_area_ids=b.data("controlData").matching_answer_ids,this.bin.feedback=b.data("controlData").feedback,this.bin.statement_text=b.text(),this.bin.$statement_html=b.html(),"fill-in-the-blank"==this.settings.mode&&b.data("controlData").blanknum&&(this.bin.blanknum=b.data("controlData").blanknum),this.$ansareas_container.find("li").each($.proxy(function(a,b){$(b).find(".screenreader_hint").html("Does <em>"+this.bin.statement_text+"</em> match this answer?")},this)),this.displaySelectedStatementHints(),this.swapZindexes(),this.transitionStatementsToBack(),this.transitionAnsareasToFore(),this.$ansareas_container.find("h2").focus(),this.settings.ansarea_selected_flag=!1}},Matching.prototype.displaySelectedStatementHints=function(){this.$ansarea_select_hint.html("- <em>click a match from the options listed below:</em>")},Matching.prototype.statementsBind=function(){this.$statements_container.find("a").on("click.Matching, keydown.Matching",$.proxy(this.statementClick,this))},Matching.prototype.buildAnsAreas=function(a){a.each($.proxy(function(a,b){this.ddClassNames.push($(b).attr("class"))},this));for(var b=this.uniquesFromArray(this.ddClassNames),c=jQuery(),d=0,e=b.length;e>d;d++){var f=b[d]+"_title";c=c.add('<li id="'+b[d]+'" class="answer_area" role="dialog" aria-describedby="'+f+'"><a href="" role="button"><span class="area_title" id="'+f+'">'+a.filter("."+b[d]).first().html()+'</span><span class="visually_hidden screenreader_hint"></span> <span class="aa_store"></span></a></li>')}this.$ansareas_container.append($("<ul></ul>").append(c)),this.$ansareas_container.find("h2").attr("tabindex","0").append(this.$ansarea_select_hint),"fill-in-the-blank"==this.settings.mode&&this.$ansareas_container.find(".fitb-blank").each(function(){$(this).attr("aria-label","Unfilled blank")}),this.ansAreasBind(),this.$ansareas_container.attr("aria-disabled","true")},Matching.prototype.ansAreasBind=function(){this.$ansareas_container.find("a").on("click.Matching, keydown.Matching",$.proxy(this.ansAreaClick,this))},Matching.prototype.ansAreaClick=function(a){if("keydown"==a.type&&13!=a.which&&32!=a.which)return!0;if(a.preventDefault(),!this.settings.ansarea_selected_flag){this.settings.ansarea_selected_flag=!0;var b=$(a.target);b.is("span")&&(b=b.closest("a"));for(var c=b.parent().attr("id"),d=!1,e=0,f=this.bin.matching_area_ids.length;f>e;e++)this.bin.matching_area_ids[e]==c&&(d=!0);if(d){if("default"==this.settings.mode)b.find(".aa_store").append($('<span class="dropped_statement" tabindex="0"></span>').append(this.bin.$statement_html));else if("fill-in-the-blank"==this.settings.mode){var g;g=this.bin.blanknum?b.find("."+this.bin.blanknum):b.find(".fitb-blank"),g.replaceWith($('<span class="dropped_statement"></span>').append(this.bin.$statement_html))}this.dropSuccess(),this.settings.any_answer_is_fine?this.message():this.message("correct")}else this.message("fail");this.bin.blanknum=null,this.$ansareas_container.find("li").each($.proxy(function(a,b){$(b).find(".screenreader_hint").empty()},this))}},Matching.prototype.message=function(a){var b="",c="";if("default"==a)return this.$instructions.removeClass("msg_steps").addClass("msg_default"),b=this.settings.msg_default,void $("h1",this.$instructions).html(b);if("msg_statement_selected"==a)this.$instructions.slideUp(100,$.proxy(function(){this.$instructions.addClass("msg_steps"),b=this.settings.msg_statement_selected,$("h1",this.$instructions).html(b),this.$instructions.slideDown(100,$.proxy(function(){},this))},this));else if("correct"==a)c=this.bin.feedback&&this.bin.feedback.correct?this.bin.feedback.correct:this.settings.msg_correct,this.$feedback_dialogue.find(".feedback_body").text(c).addClass("fb_correct"),this.bin.fb_class="fb_correct",this.$feedback_dialogue.show(),this.$feedback_dialogue.find(".feedback_control > a").focus();else if("fail"==a)c=this.bin.feedback&&this.bin.feedback.incorrect?this.bin.feedback.incorrect:this.settings.msg_fail,this.$feedback_dialogue.find(".feedback_body").text(c).addClass("fb_fail"),this.bin.fb_class="fb_fail",this.$feedback_dialogue.show(),this.$feedback_dialogue.find(".feedback_control > a").focus();else if("win"==a)c=this.settings.msg_win,this.$feedback_dialogue.find(".feedback_body").text(c).addClass("fb_win"),this.bin.fb_class="fb_win",this.$feedback_dialogue.show(),this.$feedback_dialogue.find(".feedback_control > a").focus();else if(""==a||null==a)return this.$instructions.removeClass("msg_steps").addClass("msg_default"),this.transitionStatementsToFore(),this.transitionAnsareasToBack(),this.swapZindexes(),void(this.settings.statement_selected_flag=!1);"correct"==a||"fail"==a?(this.transitionStatementsToFore(),this.transitionAnsareasToBack(),this.swapZindexes(),this.settings.statement_selected_flag=!1,this.message("default")):"win"==a&&(this.$ansareas_container.addClass("win"),this.transitionForTheWin(),$("h1",this.$instructions).html(""))},Matching.prototype.swapZindexes=function(){this.$statements_container.toggleClass("foreground background"),this.$ansareas_container.toggleClass("foreground background")},Matching.prototype.transitionStatementsToBack=function(){this.$statements_container.animate({left:"+=50",top:"+=50",opacity:this.settings.statements_back_opacity,"font-size":".9em"},this.settings.transition_length,$.proxy(function(){this.bin.show_fb_win_flag&&this.message("msg_statement_selected")},this))},Matching.prototype.transitionStatementsToFore=function(){this.$statements_container.attr("aria-disabled","false"),this.$ansareas_container.attr("aria-disabled","true"),this.$statements_container.animate({left:"-=50",top:"-=50",opacity:this.settings.fore_opacity,"font-size":"1em"},this.settings.transition_length,$.proxy(function(){this.settings.any_answer_is_fine&&this.message("default")},this))},Matching.prototype.transitionAnsareasToFore=function(){this.$statements_container.attr("aria-disabled","true"),this.$ansareas_container.attr("aria-disabled","false"),this.settings.long_statements===!0?($(".dropped_statement",this.$ansareas_container).animate({"font-size":"1em"},this.settings.transition_length),this.$ansareas_container.animate({width:"+="+this.animata.add_width,left:this.animata.wee_padmeh,opacity:this.settings.fore_opacity},this.settings.transition_length,$.proxy(function(){this.$ansareas_container.css({"padding-left":this.animata.wee_padmeh,"padding-right":this.animata.wee_padmeh,left:0})},this))):this.$ansareas_container.animate({left:this.animata.padmeh,opacity:this.settings.fore_opacity},this.settings.transition_length,$.proxy(function(){this.$ansareas_container.css({"padding-left":this.animata.padmeh,"padding-right":this.animata.padmeh,left:0})},this))},Matching.prototype.transitionAnsareasToBack=function(){var a=null,b=null;this.settings.long_statements?this.settings.long_statements&&(a={width:this.animata.aa_rest_width,left:this.animata.aa_rest_x,opacity:this.settings.answers_back_opacity},b=this.animata.wee_padmeh,$(".dropped_statement",this.$ansareas_container).animate({"font-size":".7em"},this.settings.transition_length)):(a={left:this.animata.aa_rest_x,opacity:this.settings.answers_back_opacity},b=this.animata.padmeh),this.$ansareas_container.css({"padding-left":0,"padding-right":0,left:b}),this.$ansarea_select_hint.empty(),this.$ansareas_container.animate(a,this.settings.transition_length)},Matching.prototype.transitionForTheWin=function(){this.$ansarea_select_hint.empty(),this.$statements_container.hide(1e3),this.transitionStatementsToBack(),this.transitionAnsareasToFore()},Matching.prototype.buildMessageFrom=function(){for(var a="",b=0;b<arguments.length;b++)a+=arguments[b];return a},Matching.prototype.dropSuccess=function(){this.$statements_container.find("li a").each($.proxy(function(a,b){var c=$(b);return c.data("controlData").id==this.bin.statement_id?(c.remove(),void this.$statements_container.find("h2 span.visually_hidden").html(this.statementContainerHint())):void 0},this))},Matching.prototype.checkExerciseComplete=function(){return this.$statements_container.find("li a").length?!1:!0},Matching.prototype.uniquesFromArray=function(a){var d,e,f,b=[],c=a.length;for(e=0;c>e;e++){for(d=void 0,f=0;f<b.length;f++)if(a[e]===b[f]){d=!0;break}d||b.push(a[e])}return b},Matching.prototype.shuffle=function(a){var b,c,d=a.length;if(d)for(;--d;)c=Math.floor(Math.random()*(d+1)),b=a[c],a[c]=a[d],a[d]=b;return a},Matching.prototype.setMessage=function(a,b){"correct"==a?this.settings.msg_correct=b:"fail"==a?this.settings.msg_fail=b:"win"==a?this.settings.msg_win=b:"default"==a&&(this.settings.msg_default=b)};